---
import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro';
import SidebarSublist from '@astrojs/starlight/components/SidebarSublist.astro';
import type { StarlightRouteData } from '@astrojs/starlight/route-data';
import { stripLeadingAndTrailingSlashes } from 'node_modules/@astrojs/starlight/utils/path';
import { allPages } from '~/content';
import { isSubPage } from '~/util/isSubPage';
import { stripLangFromSlug } from '~/util/path-utils';
import MobileMenuFooter from './MobileMenuFooter.astro';

const { sidebar, id } = Astro.locals.starlightRoute;

// Recursively tweaks properties of sidebar entries.
// - Adds a fallback class to entries in the sidebar that don’t exist in the current language.
// - Marks pages as “current” if they parents of pages that don’t appear in the sidebar.
type SidebarEntry = StarlightRouteData['sidebar'][number];
function markEntries(i: SidebarEntry) {
	if (i.type === 'group') {
		i.entries.forEach(markEntries);
	} else {
		const itemSlug = stripLeadingAndTrailingSlashes(i.href);
		const itemSlugWithoutLang = stripLangFromSlug(itemSlug);
		const isFallback = !allPages.some((entry) => entry.id === itemSlug);
		if (isFallback) i.attrs.class = 'fallback';
		i.isCurrent ||= isSubPage(id, itemSlugWithoutLang);
	}
}
sidebar.forEach(markEntries);

// Make sure all top-level items in the sidebar are groups.
type Group = Extract<SidebarEntry, { type: 'group' }>;
function assertGroups(sidebar: SidebarEntry[]): asserts sidebar is Group[] {
	for (const entry of sidebar) {
		if (entry.type !== 'group') {
			throw new Error('Top-level links are not permitted in the docs sidebar.');
		}
	}
}
assertGroups(sidebar);

// Get only the first sidebar group (Start section)
const firstGroup = sidebar[0];
---

<SidebarPersister>
	<SidebarSublist sublist={firstGroup.entries} />
</SidebarPersister>

<div class="md:sl-hidden">
	<MobileMenuFooter />
</div>

<style>
	/** Add "EN" to the end of sidebar items with the `fallback` class. */
	:global(.fallback)::after {
		content: 'EN';
		vertical-align: super;
		font-size: 0.75em;
		font-weight: 700;
	}

	/** Always show the scrollbar gutter. */
	:global(.sidebar-pane) {
		overflow-y: scroll;
	}
</style>
